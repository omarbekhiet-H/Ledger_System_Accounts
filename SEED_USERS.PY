# auto_year_close.py

from database.manager.financial.transactions.financial_year_manager import FinancialYearManager
from database.db_connection import get_financials_db_connection

def show_report(mgr):
    """Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ Ù„Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©"""
    years = mgr.get_detailed_years_report()
    print("\nğŸ“‘ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©:")
    for y in years:
        print(
            f"- {y['year_name']} ({y['start_date']} â†’ {y['end_date']}) "
            f"[{'Ù…Ù‚ÙÙ„Ø©' if y['is_closed'] else 'Ù…ÙØªÙˆØ­Ø©'}]"
        )
        print(f"   Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: {y['revenues']:,}")
        print(f"   Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: {y['expenses']:,}")
        print(f"   ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: {y['net_income']:,}")
        print(f"   Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„: {y['closing_entry']}")
        print("-" * 60)

def main():
    mgr = FinancialYearManager(get_financials_db_connection)

    # Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª
    years = mgr.get_all_financial_years()
    print("ğŸ“Š Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:", years)

    if not years:
        print("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†ÙˆØ§Øª Ù…Ø§Ù„ÙŠØ© - Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©...")
        if mgr.create_financial_year():
            print("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ Ø³Ù†Ø© Ù…Ø§Ù„ÙŠØ©")
            show_report(mgr)
        return

    # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ù†Ø© Ù…ÙØªÙˆØ­Ø©
    open_year = mgr.get_active_financial_year()

    if not open_year:
        print("âš ï¸ ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ù…Ù‚ÙÙˆÙ„Ø© - Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©...")
        if mgr.create_financial_year():
            print("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ù†Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©")
            show_report(mgr)
        return

    print(f"â¡ï¸ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©: {open_year['year_name']} ({open_year['start_date']} â†’ {open_year['end_date']})")

    # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø³Ù†Ø©
    can_close, msg = mgr.validate_year_for_closing(open_year['id'])
    if not can_close:
        print(f"âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ù‚ÙØ§Ù„: {msg}")
        return

    success, message = mgr.create_year_end_closing_entry(open_year['id'])
    if success:
        print("âœ… ØªÙ… Ø§Ù„Ø¥Ù‚ÙØ§Ù„:", message)
        show_report(mgr)
    else:
        print("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ù‚ÙØ§Ù„:", message)

if __name__ == "__main__":
    main()
